-- This script was generated by the ERD tool in pgAdmin 4.
-- Please log an issue at https://github.com/pgadmin-org/pgadmin4/issues/new/choose if you find any bugs, including reproduction steps.
BEGIN;


CREATE TABLE IF NOT EXISTS public.achievement_item_rewards
(
    achievement_id integer NOT NULL,
    item_id integer NOT NULL,
    quantity integer DEFAULT 1,
    CONSTRAINT achievement_item_rewards_pkey PRIMARY KEY (achievement_id, item_id)
);

CREATE TABLE IF NOT EXISTS public.achievements
(
    id serial NOT NULL,
    name character varying(100) COLLATE pg_catalog."default" NOT NULL,
    description text COLLATE pg_catalog."default" NOT NULL,
    condition jsonb NOT NULL,
    xp_reward integer DEFAULT 0,
    coin_reward integer DEFAULT 0,
    CONSTRAINT achievements_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.activity_sessions
(
    id serial NOT NULL,
    user_id integer NOT NULL,
    device_id integer,
    network_ip_id integer,
    session_start timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    session_end timestamp without time zone,
    total_screen_time interval,
    CONSTRAINT activity_sessions_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.app_name_mapping
(
    id serial NOT NULL,
    app_hash integer NOT NULL,
    app_name character varying(255) COLLATE pg_catalog."default" NOT NULL,
    app_id integer NOT NULL,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT app_name_mapping_pkey PRIMARY KEY (id),
    CONSTRAINT app_name_mapping_app_hash_key UNIQUE (app_hash)
);

CREATE TABLE IF NOT EXISTS public.app_usage_logs
(
    id serial NOT NULL,
    session_id integer NOT NULL,
    app_id integer,
    start_time timestamp without time zone,
    end_time timestamp without time zone,
    duration interval,
    productive_time interval,
    CONSTRAINT app_usage_logs_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.apps
(
    id serial NOT NULL,
    name character varying(100) COLLATE pg_catalog."default" NOT NULL,
    category character varying(50) COLLATE pg_catalog."default",
    executable_path character varying(255) COLLATE pg_catalog."default",
    is_productive boolean DEFAULT true,
    CONSTRAINT apps_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.audit_logs
(
    id serial NOT NULL,
    user_id integer,
    action character varying(100) COLLATE pg_catalog."default" NOT NULL,
    description text COLLATE pg_catalog."default",
    ip_address character varying(45) COLLATE pg_catalog."default",
    pc_name character varying(100) COLLATE pg_catalog."default",
    os_info character varying(100) COLLATE pg_catalog."default",
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT audit_logs_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.boss_item_rewards
(
    boss_id integer NOT NULL,
    item_id integer NOT NULL,
    quantity integer DEFAULT 1,
    CONSTRAINT boss_item_rewards_pkey PRIMARY KEY (boss_id, item_id)
);

CREATE TABLE IF NOT EXISTS public.bosses
(
    id serial NOT NULL,
    name character varying(100) COLLATE pg_catalog."default" NOT NULL,
    description text COLLATE pg_catalog."default",
    mechanic character varying(50) COLLATE pg_catalog."default",
    base_hp integer NOT NULL,
    spawn_reason character varying(100) COLLATE pg_catalog."default",
    xp_reward integer DEFAULT 0,
    coin_reward integer DEFAULT 0,
    difficulty character varying(20) COLLATE pg_catalog."default",
    config jsonb,
    CONSTRAINT bosses_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.browser_logs
(
    id serial NOT NULL,
    session_id integer NOT NULL,
    app_id integer,
    domain character varying(255) COLLATE pg_catalog."default" NOT NULL,
    visit_time timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    duration interval,
    is_productive boolean,
    CONSTRAINT browser_logs_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.build_logs
(
    id serial NOT NULL,
    session_id integer NOT NULL,
    app_id integer,
    success boolean,
    errors_count integer DEFAULT 0,
    log_time timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT build_logs_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.characters
(
    id serial NOT NULL,
    user_id integer NOT NULL,
    slot_index integer NOT NULL,
    name character varying(50) COLLATE pg_catalog."default" NOT NULL,
    class_id integer NOT NULL,
    sprite_base character varying(100) COLLATE pg_catalog."default",
    helmet_item character varying(100) COLLATE pg_catalog."default" DEFAULT 'none'::character varying,
    chest_item character varying(100) COLLATE pg_catalog."default" DEFAULT 'basic_tunic'::character varying,
    legs_item character varying(100) COLLATE pg_catalog."default" DEFAULT 'basic_pants'::character varying,
    boots_item character varying(100) COLLATE pg_catalog."default" DEFAULT 'none'::character varying,
    level integer DEFAULT 1,
    current_xp integer DEFAULT 0,
    hp integer DEFAULT 100,
    coins integer DEFAULT 0,
    health_streak integer DEFAULT 0,
    CONSTRAINT player_characters_pkey PRIMARY KEY (id),
    CONSTRAINT unique_character_slot UNIQUE (user_id, slot_index)
);

CREATE TABLE IF NOT EXISTS public.classes
(
    id serial NOT NULL,
    name character varying(50) COLLATE pg_catalog."default" NOT NULL,
    description text COLLATE pg_catalog."default",
    bonus_xp_per_category jsonb,
    missions_exclusive jsonb,
    skins_unlockable jsonb,
    CONSTRAINT classes_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.coin_transactions
(
    id serial NOT NULL,
    user_id integer NOT NULL,
    amount integer NOT NULL,
    reason character varying(120) COLLATE pg_catalog."default",
    ref_type character varying(50) COLLATE pg_catalog."default",
    ref_id integer,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT coin_transactions_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.devices
(
    id serial NOT NULL,
    user_id integer NOT NULL,
    device_uuid uuid NOT NULL,
    device_name character varying(100) COLLATE pg_catalog."default",
    os character varying(50) COLLATE pg_catalog."default",
    os_version character varying(50) COLLATE pg_catalog."default",
    cpu_info character varying(100) COLLATE pg_catalog."default",
    first_seen timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    last_seen timestamp without time zone,
    trusted boolean DEFAULT true,
    CONSTRAINT devices_pkey PRIMARY KEY (id),
    CONSTRAINT devices_device_uuid_key UNIQUE (device_uuid),
    CONSTRAINT unique_device_uuid UNIQUE (device_uuid)
);

CREATE TABLE IF NOT EXISTS public.email_verifications
(
    id serial NOT NULL,
    user_id integer,
    email character varying(100) COLLATE pg_catalog."default" NOT NULL,
    sent_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    expires_at timestamp without time zone NOT NULL DEFAULT (CURRENT_TIMESTAMP + '00:15:00'::interval),
    verified boolean DEFAULT false,
    verified_at timestamp without time zone,
    token character varying(6) COLLATE pg_catalog."default",
    CONSTRAINT email_verifications_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.events
(
    id serial NOT NULL,
    user_id integer,
    type character varying(50) COLLATE pg_catalog."default" NOT NULL,
    description text COLLATE pg_catalog."default",
    trigger jsonb,
    occurred_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    handled boolean DEFAULT false,
    outcome jsonb,
    CONSTRAINT events_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.export_logs
(
    id serial NOT NULL,
    user_id integer NOT NULL,
    export_type character varying(50) COLLATE pg_catalog."default",
    file_path character varying(255) COLLATE pg_catalog."default",
    generated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT export_logs_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.file_logs
(
    id serial NOT NULL,
    session_id integer NOT NULL,
    file_path character varying(255) COLLATE pg_catalog."default",
    action character varying(50) COLLATE pg_catalog."default",
    file_type character varying(50) COLLATE pg_catalog."default",
    log_time timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT file_logs_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.items
(
    id serial NOT NULL,
    sku character varying(80) COLLATE pg_catalog."default",
    name character varying(100) COLLATE pg_catalog."default" NOT NULL,
    type character varying(50) COLLATE pg_catalog."default",
    description text COLLATE pg_catalog."default",
    effect jsonb,
    duration interval,
    rarity character varying(20) COLLATE pg_catalog."default",
    price_coins integer DEFAULT 0,
    icon_path character varying(255) COLLATE pg_catalog."default",
    is_active boolean DEFAULT true,
    CONSTRAINT items_pkey PRIMARY KEY (id),
    CONSTRAINT items_sku_key UNIQUE (sku)
);

CREATE TABLE IF NOT EXISTS public.keyboard_logs
(
    id serial NOT NULL,
    session_id integer NOT NULL,
    app_id integer,
    keys_typed bigint DEFAULT 0,
    words_typed bigint DEFAULT 0,
    log_time timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT keyboard_logs_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.login_logs
(
    id serial NOT NULL,
    user_id integer NOT NULL,
    device_id integer,
    login_time timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    ip_address character varying(45) COLLATE pg_catalog."default",
    device_info text COLLATE pg_catalog."default",
    success boolean NOT NULL,
    failure_reason text COLLATE pg_catalog."default",
    CONSTRAINT login_logs_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.mission_item_rewards
(
    mission_id integer NOT NULL,
    item_id integer NOT NULL,
    quantity integer DEFAULT 1,
    CONSTRAINT mission_item_rewards_pkey PRIMARY KEY (mission_id, item_id)
);

CREATE TABLE IF NOT EXISTS public.mission_progress
(
    id serial NOT NULL,
    mission_id integer NOT NULL,
    user_id integer NOT NULL,
    metric_key character varying(50) COLLATE pg_catalog."default" NOT NULL,
    current_value bigint DEFAULT 0,
    target_value bigint DEFAULT 0,
    last_updated timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    progress_percentage numeric(5, 2) DEFAULT 0.00,
    CONSTRAINT mission_progress_pkey PRIMARY KEY (id),
    CONSTRAINT mission_progress_user_mission_metric_key UNIQUE (user_id, mission_id, metric_key)
);

CREATE TABLE IF NOT EXISTS public.missions
(
    id serial NOT NULL,
    user_id integer NOT NULL,
    title character varying(100) COLLATE pg_catalog."default" NOT NULL,
    category character varying(50) COLLATE pg_catalog."default",
    difficulty character varying(20) COLLATE pg_catalog."default",
    xp_reward integer DEFAULT 0,
    coin_reward integer DEFAULT 0,
    trigger_type character varying(50) COLLATE pg_catalog."default",
    conditions jsonb NOT NULL,
    is_manual boolean DEFAULT false,
    is_daily boolean DEFAULT false,
    is_weekly boolean DEFAULT false,
    progress integer DEFAULT 0,
    completed boolean DEFAULT false,
    completed_at timestamp without time zone,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT missions_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.mouse_logs
(
    id serial NOT NULL,
    session_id integer NOT NULL,
    app_id integer,
    mouse_clicks bigint DEFAULT 0,
    mouse_movements bigint DEFAULT 0,
    log_time timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT mouse_logs_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.network_events
(
    id serial NOT NULL,
    device_id integer NOT NULL,
    old_public_ip character varying(45) COLLATE pg_catalog."default",
    new_public_ip character varying(45) COLLATE pg_catalog."default",
    changed_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    reason character varying(100) COLLATE pg_catalog."default",
    CONSTRAINT network_events_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.network_ips
(
    id serial NOT NULL,
    device_id integer NOT NULL,
    local_ip character varying(45) COLLATE pg_catalog."default",
    public_ip character varying(45) COLLATE pg_catalog."default",
    isp character varying(100) COLLATE pg_catalog."default",
    country character varying(50) COLLATE pg_catalog."default",
    city character varying(50) COLLATE pg_catalog."default",
    first_detected timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    last_detected timestamp without time zone,
    CONSTRAINT network_ips_pkey PRIMARY KEY (id),
    CONSTRAINT unique_device_ip UNIQUE (device_id, local_ip),
    CONSTRAINT unique_device_local_ip UNIQUE (device_id, local_ip)
);

CREATE TABLE IF NOT EXISTS public.notifications
(
    id serial NOT NULL,
    user_id integer NOT NULL,
    message text COLLATE pg_catalog."default" NOT NULL,
    type character varying(50) COLLATE pg_catalog."default",
    sent_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    read boolean DEFAULT false,
    CONSTRAINT notifications_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.password_history
(
    id serial NOT NULL,
    user_id integer NOT NULL,
    password_hash character varying(255) COLLATE pg_catalog."default" NOT NULL,
    changed_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT password_history_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.payment_orders
(
    id serial NOT NULL,
    user_id integer NOT NULL,
    device_id integer,
    product_id integer NOT NULL,
    order_uuid uuid NOT NULL DEFAULT gen_random_uuid(),
    status character varying(30) COLLATE pg_catalog."default" NOT NULL DEFAULT 'created'::character varying,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT payment_orders_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.payment_product_rewards
(
    product_id integer NOT NULL,
    item_id integer NOT NULL,
    coins_amount integer DEFAULT 0,
    quantity integer DEFAULT 1,
    CONSTRAINT payment_product_rewards_pkey PRIMARY KEY (product_id, item_id)
);

CREATE TABLE IF NOT EXISTS public.payment_products
(
    id serial NOT NULL,
    sku character varying(80) COLLATE pg_catalog."default" NOT NULL,
    name character varying(120) COLLATE pg_catalog."default" NOT NULL,
    description text COLLATE pg_catalog."default",
    price_cents integer NOT NULL,
    currency character varying(10) COLLATE pg_catalog."default" NOT NULL DEFAULT 'USD'::character varying,
    product_type character varying(30) COLLATE pg_catalog."default" NOT NULL,
    metadata jsonb,
    is_active boolean DEFAULT true,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT payment_products_pkey PRIMARY KEY (id),
    CONSTRAINT payment_products_sku_key UNIQUE (sku)
);

CREATE TABLE IF NOT EXISTS public.payment_transactions
(
    id serial NOT NULL,
    order_id integer NOT NULL,
    provider character varying(40) COLLATE pg_catalog."default" NOT NULL,
    provider_tx_id character varying(120) COLLATE pg_catalog."default",
    amount_cents integer NOT NULL,
    currency character varying(10) COLLATE pg_catalog."default" NOT NULL DEFAULT 'USD'::character varying,
    status character varying(30) COLLATE pg_catalog."default" NOT NULL,
    raw_payload jsonb,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT payment_transactions_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.session_tokens
(
    id serial NOT NULL,
    user_id integer NOT NULL,
    token text COLLATE pg_catalog."default" NOT NULL,
    issued_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    expires_at timestamp without time zone,
    revoked boolean DEFAULT false,
    CONSTRAINT session_tokens_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.store_offer_items
(
    offer_id integer NOT NULL,
    item_id integer NOT NULL,
    quantity integer DEFAULT 1,
    CONSTRAINT store_offer_items_pkey PRIMARY KEY (offer_id, item_id)
);

CREATE TABLE IF NOT EXISTS public.store_offers
(
    id serial NOT NULL,
    offer_name character varying(120) COLLATE pg_catalog."default" NOT NULL,
    description text COLLATE pg_catalog."default",
    offer_type character varying(30) COLLATE pg_catalog."default" NOT NULL,
    coin_price integer DEFAULT 0,
    is_featured boolean DEFAULT false,
    is_active boolean DEFAULT true,
    metadata jsonb,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT store_offers_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.user_achievements
(
    id serial NOT NULL,
    user_id integer NOT NULL,
    achievement_id integer NOT NULL,
    unlocked_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT user_achievements_pkey PRIMARY KEY (id),
    CONSTRAINT user_achievements_user_id_achievement_id_key UNIQUE (user_id, achievement_id)
);

CREATE TABLE IF NOT EXISTS public.user_boss_encounters
(
    id serial NOT NULL,
    user_id integer NOT NULL,
    boss_id integer NOT NULL,
    session_id integer,
    spawn_time timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    defeated boolean DEFAULT false,
    defeated_at timestamp without time zone,
    hp_remaining integer,
    actions_taken jsonb,
    CONSTRAINT user_boss_encounters_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.user_inventory
(
    id serial NOT NULL,
    user_id integer NOT NULL,
    item_id integer NOT NULL,
    quantity integer DEFAULT 1,
    equipped boolean DEFAULT false,
    acquired_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT user_inventory_pkey PRIMARY KEY (id),
    CONSTRAINT user_inventory_user_id_item_id_key UNIQUE (user_id, item_id)
);

CREATE TABLE IF NOT EXISTS public.user_settings
(
    id serial NOT NULL,
    user_id integer NOT NULL,
    setting_key character varying(100) COLLATE pg_catalog."default" NOT NULL,
    setting_value text COLLATE pg_catalog."default",
    updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT user_settings_pkey PRIMARY KEY (id),
    CONSTRAINT user_settings_user_id_setting_key_key UNIQUE (user_id, setting_key)
);

CREATE TABLE IF NOT EXISTS public.users
(
    id serial NOT NULL,
    username character varying(50) COLLATE pg_catalog."default" NOT NULL,
    email character varying(100) COLLATE pg_catalog."default" NOT NULL,
    password_hash character varying(255) COLLATE pg_catalog."default" NOT NULL,
    avatar character varying(255) COLLATE pg_catalog."default",
    selected_class_id integer,
    level integer DEFAULT 1,
    current_xp integer DEFAULT 0,
    total_xp integer DEFAULT 0,
    coins integer DEFAULT 0,
    health_streak integer DEFAULT 0,
    total_play_time interval DEFAULT '00:00:00'::interval,
    last_sync timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    is_active boolean DEFAULT false,
    CONSTRAINT users_pkey PRIMARY KEY (id),
    CONSTRAINT users_email_key UNIQUE (email),
    CONSTRAINT users_username_key UNIQUE (username)
);

CREATE TABLE IF NOT EXISTS public.xp_history
(
    id serial NOT NULL,
    user_id integer NOT NULL,
    amount integer NOT NULL,
    reason character varying(120) COLLATE pg_catalog."default",
    ref_type character varying(50) COLLATE pg_catalog."default",
    ref_id integer,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT xp_history_pkey PRIMARY KEY (id)
);

ALTER TABLE IF EXISTS public.achievement_item_rewards
    ADD CONSTRAINT achievement_item_rewards_achievement_id_fkey FOREIGN KEY (achievement_id)
    REFERENCES public.achievements (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.achievement_item_rewards
    ADD CONSTRAINT achievement_item_rewards_item_id_fkey FOREIGN KEY (item_id)
    REFERENCES public.items (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.activity_sessions
    ADD CONSTRAINT activity_sessions_device_id_fkey FOREIGN KEY (device_id)
    REFERENCES public.devices (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE SET NULL;
CREATE INDEX IF NOT EXISTS idx_activity_sessions_device
    ON public.activity_sessions(device_id);


ALTER TABLE IF EXISTS public.activity_sessions
    ADD CONSTRAINT activity_sessions_network_ip_id_fkey FOREIGN KEY (network_ip_id)
    REFERENCES public.network_ips (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE SET NULL;


ALTER TABLE IF EXISTS public.activity_sessions
    ADD CONSTRAINT activity_sessions_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_activity_sessions_user
    ON public.activity_sessions(user_id);


ALTER TABLE IF EXISTS public.app_name_mapping
    ADD CONSTRAINT app_name_mapping_app_id_fkey FOREIGN KEY (app_id)
    REFERENCES public.apps (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.app_usage_logs
    ADD CONSTRAINT app_usage_logs_app_id_fkey FOREIGN KEY (app_id)
    REFERENCES public.apps (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE SET NULL;


ALTER TABLE IF EXISTS public.app_usage_logs
    ADD CONSTRAINT app_usage_logs_session_id_fkey FOREIGN KEY (session_id)
    REFERENCES public.activity_sessions (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_app_usage_session
    ON public.app_usage_logs(session_id);


ALTER TABLE IF EXISTS public.boss_item_rewards
    ADD CONSTRAINT boss_item_rewards_boss_id_fkey FOREIGN KEY (boss_id)
    REFERENCES public.bosses (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.boss_item_rewards
    ADD CONSTRAINT boss_item_rewards_item_id_fkey FOREIGN KEY (item_id)
    REFERENCES public.items (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.browser_logs
    ADD CONSTRAINT browser_logs_app_id_fkey FOREIGN KEY (app_id)
    REFERENCES public.apps (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE SET NULL;


ALTER TABLE IF EXISTS public.browser_logs
    ADD CONSTRAINT browser_logs_session_id_fkey FOREIGN KEY (session_id)
    REFERENCES public.activity_sessions (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_browser_logs_session
    ON public.browser_logs(session_id);


ALTER TABLE IF EXISTS public.build_logs
    ADD CONSTRAINT build_logs_app_id_fkey FOREIGN KEY (app_id)
    REFERENCES public.apps (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE SET NULL;


ALTER TABLE IF EXISTS public.build_logs
    ADD CONSTRAINT build_logs_session_id_fkey FOREIGN KEY (session_id)
    REFERENCES public.activity_sessions (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_build_logs_session
    ON public.build_logs(session_id);


ALTER TABLE IF EXISTS public.characters
    ADD CONSTRAINT player_characters_class_id_fkey FOREIGN KEY (class_id)
    REFERENCES public.classes (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.characters
    ADD CONSTRAINT player_characters_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.coin_transactions
    ADD CONSTRAINT coin_transactions_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_coin_transactions_user
    ON public.coin_transactions(user_id);


ALTER TABLE IF EXISTS public.devices
    ADD CONSTRAINT devices_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_devices_user
    ON public.devices(user_id);


ALTER TABLE IF EXISTS public.email_verifications
    ADD CONSTRAINT email_verifications_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.events
    ADD CONSTRAINT events_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE SET NULL;


ALTER TABLE IF EXISTS public.export_logs
    ADD CONSTRAINT export_logs_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.file_logs
    ADD CONSTRAINT file_logs_session_id_fkey FOREIGN KEY (session_id)
    REFERENCES public.activity_sessions (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_file_logs_session
    ON public.file_logs(session_id);


ALTER TABLE IF EXISTS public.keyboard_logs
    ADD CONSTRAINT keyboard_logs_app_id_fkey FOREIGN KEY (app_id)
    REFERENCES public.apps (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE SET NULL;


ALTER TABLE IF EXISTS public.keyboard_logs
    ADD CONSTRAINT keyboard_logs_session_id_fkey FOREIGN KEY (session_id)
    REFERENCES public.activity_sessions (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_keyboard_logs_session
    ON public.keyboard_logs(session_id);


ALTER TABLE IF EXISTS public.login_logs
    ADD CONSTRAINT login_logs_device_id_fkey FOREIGN KEY (device_id)
    REFERENCES public.devices (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE SET NULL;
CREATE INDEX IF NOT EXISTS idx_login_logs_device
    ON public.login_logs(device_id);


ALTER TABLE IF EXISTS public.login_logs
    ADD CONSTRAINT login_logs_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_login_logs_user
    ON public.login_logs(user_id);


ALTER TABLE IF EXISTS public.mission_item_rewards
    ADD CONSTRAINT mission_item_rewards_item_id_fkey FOREIGN KEY (item_id)
    REFERENCES public.items (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.mission_item_rewards
    ADD CONSTRAINT mission_item_rewards_mission_id_fkey FOREIGN KEY (mission_id)
    REFERENCES public.missions (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.mission_progress
    ADD CONSTRAINT mission_progress_mission_id_fkey FOREIGN KEY (mission_id)
    REFERENCES public.missions (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.mission_progress
    ADD CONSTRAINT mission_progress_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.missions
    ADD CONSTRAINT missions_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_missions_user
    ON public.missions(user_id);


ALTER TABLE IF EXISTS public.mouse_logs
    ADD CONSTRAINT mouse_logs_app_id_fkey FOREIGN KEY (app_id)
    REFERENCES public.apps (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE SET NULL;


ALTER TABLE IF EXISTS public.mouse_logs
    ADD CONSTRAINT mouse_logs_session_id_fkey FOREIGN KEY (session_id)
    REFERENCES public.activity_sessions (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_mouse_logs_session
    ON public.mouse_logs(session_id);


ALTER TABLE IF EXISTS public.network_events
    ADD CONSTRAINT network_events_device_id_fkey FOREIGN KEY (device_id)
    REFERENCES public.devices (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_network_events_device
    ON public.network_events(device_id);


ALTER TABLE IF EXISTS public.network_ips
    ADD CONSTRAINT network_ips_device_id_fkey FOREIGN KEY (device_id)
    REFERENCES public.devices (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_network_device
    ON public.network_ips(device_id);


ALTER TABLE IF EXISTS public.notifications
    ADD CONSTRAINT notifications_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.password_history
    ADD CONSTRAINT password_history_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.payment_orders
    ADD CONSTRAINT payment_orders_device_id_fkey FOREIGN KEY (device_id)
    REFERENCES public.devices (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE SET NULL;


ALTER TABLE IF EXISTS public.payment_orders
    ADD CONSTRAINT payment_orders_product_id_fkey FOREIGN KEY (product_id)
    REFERENCES public.payment_products (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE RESTRICT;


ALTER TABLE IF EXISTS public.payment_orders
    ADD CONSTRAINT payment_orders_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_payment_orders_user
    ON public.payment_orders(user_id);


ALTER TABLE IF EXISTS public.payment_product_rewards
    ADD CONSTRAINT payment_product_rewards_item_id_fkey FOREIGN KEY (item_id)
    REFERENCES public.items (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE SET NULL;


ALTER TABLE IF EXISTS public.payment_product_rewards
    ADD CONSTRAINT payment_product_rewards_product_id_fkey FOREIGN KEY (product_id)
    REFERENCES public.payment_products (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.payment_transactions
    ADD CONSTRAINT payment_transactions_order_id_fkey FOREIGN KEY (order_id)
    REFERENCES public.payment_orders (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_payment_tx_order
    ON public.payment_transactions(order_id);


ALTER TABLE IF EXISTS public.session_tokens
    ADD CONSTRAINT session_tokens_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.store_offer_items
    ADD CONSTRAINT store_offer_items_item_id_fkey FOREIGN KEY (item_id)
    REFERENCES public.items (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.store_offer_items
    ADD CONSTRAINT store_offer_items_offer_id_fkey FOREIGN KEY (offer_id)
    REFERENCES public.store_offers (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.user_achievements
    ADD CONSTRAINT user_achievements_achievement_id_fkey FOREIGN KEY (achievement_id)
    REFERENCES public.achievements (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.user_achievements
    ADD CONSTRAINT user_achievements_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.user_boss_encounters
    ADD CONSTRAINT user_boss_encounters_boss_id_fkey FOREIGN KEY (boss_id)
    REFERENCES public.bosses (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.user_boss_encounters
    ADD CONSTRAINT user_boss_encounters_session_id_fkey FOREIGN KEY (session_id)
    REFERENCES public.activity_sessions (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE SET NULL;


ALTER TABLE IF EXISTS public.user_boss_encounters
    ADD CONSTRAINT user_boss_encounters_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.user_inventory
    ADD CONSTRAINT user_inventory_item_id_fkey FOREIGN KEY (item_id)
    REFERENCES public.items (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.user_inventory
    ADD CONSTRAINT user_inventory_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.user_settings
    ADD CONSTRAINT user_settings_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.users
    ADD CONSTRAINT fk_user_class FOREIGN KEY (selected_class_id)
    REFERENCES public.classes (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE SET NULL;


ALTER TABLE IF EXISTS public.xp_history
    ADD CONSTRAINT xp_history_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_xp_history_user
    ON public.xp_history(user_id);

END;