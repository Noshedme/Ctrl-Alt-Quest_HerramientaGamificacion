# ğŸ® DIAGRAMA DEL SISTEMA DE EVENTOS CONTEXTUALES

## Arquitectura General

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CTRL+ALT+QUEST GAMIFICATION                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         HOME CONTROLLER (UI)                              â”‚
â”‚  â”œâ”€ Implements: XPChangeListener + EventContextualListener               â”‚
â”‚  â”œâ”€ Displays: XP Bar, Level, Events Dialog                              â”‚
â”‚  â””â”€ Updates: Real-time via Platform.runLater()                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²              â–²                          â–²
         â”‚              â”‚                          â”‚
         â”‚ notifies     â”‚ notifies                 â”‚ updates
         â”‚ XP changes   â”‚ event events            â”‚ UI
         â”‚              â”‚                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                â”‚  â”‚                     â”‚  â”‚                   â”‚
â”‚ XPSyncService â”‚  â”‚ EventContextualUI   â”‚  â”‚  SoundManager     â”‚
â”‚                â”‚  â”‚                     â”‚  â”‚                   â”‚
â”‚ â”œâ”€ awardXP    â”‚  â”‚ â”œâ”€ showRestBreak    â”‚  â”‚ â”œâ”€ playEvent      â”‚
â”‚ â”œâ”€ checkLevel â”‚  â”‚ â”œâ”€ showQuickMission â”‚  â”‚ â”œâ”€ playEventWin   â”‚
â”‚ â”œâ”€ cached dataâ”‚  â”‚ â”œâ”€ showBossBattle   â”‚  â”‚ â””â”€ playEventFail  â”‚
â”‚ â””â”€ level-ups  â”‚  â”‚ â””â”€ timer handling   â”‚  â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                â”‚
         â”‚                â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ EventContextualService      â”‚
         â”‚                             â”‚
         â”‚ â”œâ”€ startEventGenerator()    â”‚
         â”‚ â”œâ”€ generateRandomEvent()    â”‚
         â”‚ â”œâ”€ completeEvent()          â”‚
         â”‚ â”œâ”€ stopEventGenerator()     â”‚
         â”‚ â””â”€ addEventListener()       â”‚
         â”‚                             â”‚
         â”‚ Internal:                   â”‚
         â”‚ â”œâ”€ ScheduledExecutorService â”‚
         â”‚ â”œâ”€ CopyOnWriteArrayList     â”‚
         â”‚ â””â”€ ContextualEvent objects  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ registers events
                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  ActivityMonitorService     â”‚
         â”‚                             â”‚
         â”‚ â”œâ”€ startMonitoring()        â”‚
         â”‚ â”œâ”€ reportActivity()         â”‚
         â”‚ â””â”€ stopMonitoring()         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ starts/stops
                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    DatabaseConnection       â”‚
         â”‚                             â”‚
         â”‚ â”œâ”€ public.events table      â”‚
         â”‚ â”œâ”€ xp_history table         â”‚
         â”‚ â”œâ”€ missions table           â”‚
         â”‚ â””â”€ achievements table       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flujo de GeneraciÃ³n de Eventos

```
Timer: Cada 3 minutos (180 segundos)
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EventContextualService.ContextualEvent  â”‚
â”‚ Task.run()                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ generateRandomEvent(userId)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Selecciona tipo aleatorio:              â”‚
â”‚ â”œâ”€ 33%: REST_BREAK     (50 XP)          â”‚
â”‚ â”œâ”€ 33%: QUICK_MISSION  (75 XP)          â”‚
â”‚ â””â”€ 33%: BOSS_BATTLE   (100 XP)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ notifyEventGenerated()                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Itera sobre listeners y ejecuta:        â”‚
â”‚ listener.onEventGenerated(userId, event)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚          â”‚          â”‚
      â–¼          â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚EventUI  â”‚ â”‚HomeCtrl  â”‚ â”‚(other        â”‚
â”‚notify   â”‚ â”‚notify    â”‚ â”‚listeners)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚         â”‚
       â–¼         â–¼
    Show      Log
   Dialog      Event
```

---

## Flujo de CompletaciÃ³n de Evento

```
Usuario InteractÃºa con Evento
â”œâ”€ REST_BREAK: Timer termina o presiona "Saltar"
â”œâ”€ QUICK_MISSION: Progreso alcanza 100%
â””â”€ BOSS_BATTLE: Salud boss llega a 0
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EventContextualService.       â”‚
â”‚ completeEvent(userId, id,     â”‚
â”‚              success)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ if (success == true)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                 â”‚
   â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Award XP â”‚   â”‚ Update BD     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                â”‚
     â–¼                â–¼
XPSyncService  recordEventCompletion()
.awardXP()     UPDATE public.events
     â”‚         SET outcome = JSON
     â–¼
notifyEventCompleted() â—„â”€â”€â”€â”€â”€â”
     â”‚                       â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚              â”‚        â”‚
     â–¼              â–¼        â–¼
EventUI       HomeCtrl   (other)
playWinSound  updateUI   listeners
playVictory   animLevel
```

---

## Estados de un Evento

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    GENERATED    â”‚
                    â”‚  (Random event) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     STARTED     â”‚
                    â”‚ (UI Dialog open)â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                      â”‚
        â–¼                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  COMPLETED   â”‚                      â”‚   ABORTED    â”‚
â”‚  (success)   â”‚                      â”‚  (cancelled) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                     â”‚
       â–¼                                     â–¼
   XP Award                            No XP Award
   BD Record                           BD Record
   Celebration                         Fail Sound
```

---

## IntegraciÃ³n con Sistemas Existentes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           EVENT CONTEXTUAL SERVICE (Nueva)               â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ calls
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                         â”‚
     â–¼ Otorga XP                              â–¼ Consulta
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ XPSyncService   â”‚                      â”‚ Database     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ award XP      â”‚â—„â”€â”€â”€â”€â”€â”€â”             â”‚ â€¢ events     â”‚
â”‚ â€¢ level up      â”‚       â”‚ persists   â”‚ â€¢ xp_history â”‚
â”‚ â€¢ cache        â”‚        â”‚ data      â”‚ â€¢ users      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                  â”‚
         â–¼                  â”‚
    Notifies               â”‚
         â”‚                  â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”
    â”‚             â”‚           â”‚
    â–¼             â–¼           â–¼
HomeCtrl   MissionProgress  Achievements
XPChange   Service          Service
Listener   (integrated)     (integrated)
 â”‚                          â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
          User Sees:
          - XP update
          - Level up?
          - Missions progress
          - Achievements unlocked
```

---

## Tipos de Eventos en Detalle

### 1. REST_BREAK â°
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ REST_BREAK                     â”‚
â”‚                                â”‚
â”‚ Title: "â° TÃ³mate un Descanso" â”‚
â”‚ Duration: 30 seconds          â”‚
â”‚ XP Reward: 50                 â”‚
â”‚                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Timer: 30 â†’ 0 (countdownâ”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                â”‚
â”‚ [Saltar Descanso]             â”‚
â”‚                                â”‚
â”‚ Completion:                    â”‚
â”‚ â”œâ”€ Auto: Timer ends = Success â”‚
â”‚ â””â”€ Manual: Click = Failed     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. QUICK_MISSION âš¡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ QUICK_MISSION                  â”‚
â”‚                                â”‚
â”‚ Title: "âš¡ MisiÃ³n RÃ¡pida"      â”‚
â”‚ XP Reward: 75                 â”‚
â”‚                                â”‚
â”‚ Description: "Escribe 100     â”‚
â”‚  palabras" (variante)         â”‚
â”‚                                â”‚
â”‚ Progress: â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 50%      â”‚
â”‚                                â”‚
â”‚ [Cancelar MisiÃ³n]             â”‚
â”‚                                â”‚
â”‚ Completion:                    â”‚
â”‚ â””â”€ Auto: Progress 0â†’100       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. BOSS_BATTLE âš”ï¸
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BOSS_BATTLE                    â”‚
â”‚                                â”‚
â”‚ Title: "âš”ï¸ Â¡Boss ApareciÃ³!"   â”‚
â”‚ Boss: "ProcrastinaciÃ³n Boss"  â”‚
â”‚ XP Reward: 100                â”‚
â”‚                                â”‚
â”‚ Health: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100/100         â”‚
â”‚                                â”‚
â”‚      [ATACAR]                 â”‚
â”‚       (red button)             â”‚
â”‚                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚ â”‚ Click â†’ dmg  â”‚              â”‚
â”‚ â”‚ Health -= 20 â”‚              â”‚
â”‚ â”‚ Repeat Ã—5    â”‚              â”‚
â”‚ â”‚ = Victory!   â”‚              â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Timeline de EjecuciÃ³n

```
User Logs In
    â”‚
    â–¼
HomeController.initialize()
    â”‚
    â”œâ”€â”€â†’ ActivityMonitorService.startMonitoring(userId)
    â”‚    â””â”€â”€â†’ EventContextualService.startEventGenerator(userId)
    â”‚         â””â”€â”€â†’ scheduler.scheduleAtFixedRate(..., 180, 180, SECONDS)
    â”‚              â”‚
    â”‚              â””â”€â”€â†’ [Timer Start: 180 seconds]
    â”‚
    â””â”€â”€â†’ Platform.runLater(loadView("dashboard"))
        â””â”€â”€â†’ showDashboard()
              â”‚
              â””â”€â”€â†’ [User seeing UI]

After 180 seconds (3 minutes):
    â”‚
    â–¼
ScheduledExecutorService triggers
    â”‚
    â–¼
ContextualEventTask.run()
    â”‚
    â”œâ”€â”€â†’ generateRandomEvent()
    â”‚    â””â”€â”€â†’ Create ContextualEvent object
    â”‚
    â”œâ”€â”€â†’ notifyEventGenerated()
    â”‚    â””â”€â”€â†’ EventContextualUI.onEventGenerated()
    â”‚         â””â”€â”€â†’ setCurrentEvent()
    â”‚
    â”œâ”€â”€â†’ notifyEventStarted()
    â”‚    â””â”€â”€â†’ EventContextualUI.onEventStarted()
    â”‚         â””â”€â”€â†’ showRestBreakDialog() OR
    â”‚              showQuickMissionDialog() OR
    â”‚              showBossBattleDialog()
    â”‚
    â””â”€â”€â†’ [Wait for user interaction]
         â”‚
         â””â”€â”€â†’ [User completes/cancels event]
               â”‚
               â”œâ”€â”€â†’ completeEvent(userId, eventId, success)
               â”‚    â”‚
               â”‚    â”œâ”€â”€â†’ XPSyncService.awardXPFromActivity()
               â”‚    â”‚    â””â”€â”€â†’ notifyXPChange() [updates UI]
               â”‚    â”‚
               â”‚    â””â”€â”€â†’ recordEventCompletion() [saves to BD]
               â”‚
               â””â”€â”€â†’ notifyEventCompleted()
                    â”œâ”€â”€â†’ EventContextualUI.onEventCompleted()
                    â”‚    â””â”€â”€â†’ playSound() + showVictory()
                    â”‚
                    â”œâ”€â”€â†’ HomeController.onEventCompleted()
                    â”‚    â””â”€â”€â†’ updateUI in JavaFX thread
                    â”‚
                    â””â”€â”€â†’ [Timer restarts for next event]
```

---

## Seguridad y Threading

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EventContextualService Threading Model              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”œâ”€ listeners: CopyOnWriteArrayList                 â”‚
â”‚ â”‚  â””â”€ Thread-safe iteration while adding/removing  â”‚
â”‚ â”‚                                                   â”‚
â”‚ â”œâ”€ activeTasks: Collections.synchronizedMap()      â”‚
â”‚ â”‚  â””â”€ Thread-safe HashMap access                   â”‚
â”‚ â”‚                                                   â”‚
â”‚ â”œâ”€ scheduler: ScheduledExecutorService             â”‚
â”‚ â”‚  â””â”€ Single thread pool for periodic tasks        â”‚
â”‚ â”‚                                                   â”‚
â”‚ â””â”€ DB operations: Connection per statement         â”‚
â”‚    â””â”€ Each INSERT/UPDATE has try-with-resources    â”‚
â”‚                                                     â”‚
â”‚ All UI updates via Platform.runLater()             â”‚
â”‚ â†’ Ensures JavaFX thread safety                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Persistencia de Datos

```
public.events table schema:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Column         â”‚ Type      â”‚ Purpose  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)      â”‚ UUID      â”‚ PK      â”‚
â”‚ user_id        â”‚ INT       â”‚ FK      â”‚
â”‚ type           â”‚ VARCHAR   â”‚ Event   â”‚
â”‚                â”‚           â”‚ type    â”‚
â”‚ created_at     â”‚ TIMESTAMP â”‚ When    â”‚
â”‚                â”‚           â”‚ created â”‚
â”‚ handled        â”‚ BOOLEAN   â”‚ Is      â”‚
â”‚                â”‚           â”‚ completeâ”‚
â”‚ outcome        â”‚ JSONB     â”‚ Success â”‚
â”‚                â”‚           â”‚ + XP    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

outcome JSON example:
{
  "success": true,
  "xp_earned": 50,
  "completed_at": "2026-02-16T12:05:30Z"
}
```

---

**Ãšltimo Actualizado**: 16/02/2026  
**Estado**: âœ… Completamente implementado
